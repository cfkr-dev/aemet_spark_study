@startuml
actor User

participant "AemetAPIClient" as AEMET_CLIENT
participant "AllStationsData" as STATION_DATA
participant "AllStationsMeteo" as METEO_DATA
participant "HTTPUtils" as HTTP_UTILS
participant "FileUtils" as FILE_UTILS

User -> AEMET_CLIENT : aemetDataExtraction()
activate AEMET_CLIENT

'--- Station Metadata ---
AEMET_CLIENT -> STATION_DATA : saveStationInfoMetadata()
activate STATION_DATA
STATION_DATA -> STATION_DATA : doWhileWithGetAndSave()
alt retry until success
    STATION_DATA -> HTTP_UTILS : getAemetAPIResource(metadata=true)
    alt success
        HTTP_UTILS --> STATION_DATA : JSON response
        STATION_DATA -> FILE_UTILS : saveContentToPath(metadata)
        FILE_UTILS --> STATION_DATA : success
    else failure
        HTTP_UTILS --> STATION_DATA : exception
        STATION_DATA -> STATION_DATA : retry doWhileWithGetAndSave()
    end
end
STATION_DATA --> AEMET_CLIENT : done
deactivate STATION_DATA

'--- Meteo Metadata ---
AEMET_CLIENT -> METEO_DATA : saveStationMeteoInfoMetadata()
activate METEO_DATA
METEO_DATA -> METEO_DATA : doWhileWithGetAndSave()
alt retry until success
    METEO_DATA -> HTTP_UTILS : getAemetAPIResource(metadata=true)
    alt success
        HTTP_UTILS --> METEO_DATA : JSON response
        METEO_DATA -> FILE_UTILS : saveContentToPath(metadata)
        FILE_UTILS --> METEO_DATA : success
    else failure
        HTTP_UTILS --> METEO_DATA : exception
        METEO_DATA -> METEO_DATA : retry doWhileWithGetAndSave()
    end
end
METEO_DATA --> AEMET_CLIENT : done
deactivate METEO_DATA

'--- Station Data ---
AEMET_CLIENT -> STATION_DATA : saveStationInfo()
activate STATION_DATA
STATION_DATA -> STATION_DATA : doWhileWithGetAndSave()
alt retry until success
    STATION_DATA -> HTTP_UTILS : getAemetAPIResource(metadata=false)
    alt success
        HTTP_UTILS --> STATION_DATA : JSON response
        STATION_DATA -> FILE_UTILS : saveContentToPath(data)
        FILE_UTILS --> STATION_DATA : success
    else failure
        HTTP_UTILS --> STATION_DATA : exception
        STATION_DATA -> STATION_DATA : retry doWhileWithGetAndSave()
    end
end
STATION_DATA --> AEMET_CLIENT : done
deactivate STATION_DATA

'--- Meteo Data ---
AEMET_CLIENT -> METEO_DATA : saveStationMeteoInfo()
activate METEO_DATA
METEO_DATA -> METEO_DATA : saveStationMeteoInfoAction() [loop over date ranges]
alt retry until success
    METEO_DATA -> HTTP_UTILS : getAemetAPIResource(metadata=false)
    alt success
        HTTP_UTILS --> METEO_DATA : JSON response
        METEO_DATA -> FILE_UTILS : saveContentToPath(data)
        FILE_UTILS --> METEO_DATA : success
        METEO_DATA -> FILE_UTILS : save last saved date
        FILE_UTILS --> METEO_DATA : done
    else failure
        HTTP_UTILS --> METEO_DATA : exception
        METEO_DATA -> METEO_DATA : retry doWhileWithGetAndSave()
    end
end
METEO_DATA --> AEMET_CLIENT : done
deactivate METEO_DATA

AEMET_CLIENT --> User : finished
deactivate AEMET_CLIENT
@enduml
