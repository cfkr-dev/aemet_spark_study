@startuml
participant "SparkQueriesCore" as SPARK_QUERIES_CORE
participant "SingleParamStudiesQueriesCore" as SINGLE_PARAM_STUDIES_QUERIES_CORE
participant "SparkSessionCore" as SPARK_SESSION_CORE
participant "Storage" as STORAGE

SPARK_QUERIES_CORE -> SINGLE_PARAM_STUDIES_QUERIES_CORE : execute()
activate SINGLE_PARAM_STUDIES_QUERIES_CORE

loop for each studyParam

    group Top 10 highest (year/decade/global)
        SINGLE_PARAM_STUDIES_QUERIES_CORE -> SPARK_QUERIES_CORE : getTopNClimateParamInALapse(params)
        SPARK_QUERIES_CORE --> SINGLE_PARAM_STUDIES_QUERIES_CORE : DataFrame
        SINGLE_PARAM_STUDIES_QUERIES_CORE -> SPARK_SESSION_CORE : saveDataframeAsParquet(resultsDF, path)
        SPARK_SESSION_CORE -> STORAGE : write parquet
        STORAGE --> SPARK_SESSION_CORE : saved
        SPARK_SESSION_CORE --> SINGLE_PARAM_STUDIES_QUERIES_CORE : saved
    end

    group Top 10 lowest (year/decade/global)
        SINGLE_PARAM_STUDIES_QUERIES_CORE -> SPARK_QUERIES_CORE : getTopNClimateParamInALapse(params, highest=false)
        SPARK_QUERIES_CORE --> SINGLE_PARAM_STUDIES_QUERIES_CORE : DataFrame
        SINGLE_PARAM_STUDIES_QUERIES_CORE -> SPARK_SESSION_CORE : saveDataframeAsParquet(resultsDF, path)
        SPARK_SESSION_CORE -> STORAGE : write parquet
        STORAGE --> SPARK_SESSION_CORE : saved
        SPARK_SESSION_CORE --> SINGLE_PARAM_STUDIES_QUERIES_CORE : saved
    end

    group Evolution for each state
        loop reprStationRegs as record
            SINGLE_PARAM_STUDIES_QUERIES_CORE -> SPARK_QUERIES_CORE : getStationInfoById(record.stationIdGlobal)
            SPARK_QUERIES_CORE --> SINGLE_PARAM_STUDIES_QUERIES_CORE : StationInfo DF
            SINGLE_PARAM_STUDIES_QUERIES_CORE -> SPARK_SESSION_CORE : saveDataframeAsJSON(stationDf, path)
            SPARK_SESSION_CORE -> STORAGE : write json
            STORAGE --> SPARK_SESSION_CORE : saved
            SPARK_SESSION_CORE --> SINGLE_PARAM_STUDIES_QUERIES_CORE : saved

            SINGLE_PARAM_STUDIES_QUERIES_CORE -> SPARK_QUERIES_CORE : getStationInfoById(record.stationIdLatest)
            SPARK_QUERIES_CORE --> SINGLE_PARAM_STUDIES_QUERIES_CORE : StationInfo DF
            SINGLE_PARAM_STUDIES_QUERIES_CORE -> SPARK_SESSION_CORE : saveDataframeAsJSON(stationDf, path)
            SPARK_SESSION_CORE -> STORAGE : write json
            STORAGE --> SPARK_SESSION_CORE : saved
            SPARK_SESSION_CORE --> SINGLE_PARAM_STUDIES_QUERIES_CORE : saved

            SINGLE_PARAM_STUDIES_QUERIES_CORE -> SPARK_QUERIES_CORE : getClimateParamInALapseById(record.stationIdLatest, params)
            SPARK_QUERIES_CORE --> SINGLE_PARAM_STUDIES_QUERIES_CORE : DataFrame
            SINGLE_PARAM_STUDIES_QUERIES_CORE -> SPARK_SESSION_CORE : saveDataframeAsParquet(resultsDF, path)
            SPARK_SESSION_CORE -> STORAGE : write parquet
            STORAGE --> SPARK_SESSION_CORE : saved
            SPARK_SESSION_CORE --> SINGLE_PARAM_STUDIES_QUERIES_CORE : saved

            SINGLE_PARAM_STUDIES_QUERIES_CORE -> SPARK_QUERIES_CORE : getClimateYearlyGroupById(record.stationIdGlobal, params)
            SPARK_QUERIES_CORE --> SINGLE_PARAM_STUDIES_QUERIES_CORE : DataFrame
            SINGLE_PARAM_STUDIES_QUERIES_CORE -> SPARK_SESSION_CORE : saveDataframeAsParquet(resultsDF, path)
            SPARK_SESSION_CORE -> STORAGE : write parquet
            STORAGE --> SPARK_SESSION_CORE : saved
            SPARK_SESSION_CORE --> SINGLE_PARAM_STUDIES_QUERIES_CORE : saved

            SINGLE_PARAM_STUDIES_QUERIES_CORE -> SPARK_QUERIES_CORE : getStationClimateParamRegressionModelInALapse(record.stationIdGlobal, params)
            SPARK_QUERIES_CORE --> SINGLE_PARAM_STUDIES_QUERIES_CORE : Regression DF (row)
            SINGLE_PARAM_STUDIES_QUERIES_CORE -> SINGLE_PARAM_STUDIES_QUERIES_CORE : accumulate regressionModelDf
        end

        ' Persist regressionModelDf in memory and materialize
        SINGLE_PARAM_STUDIES_QUERIES_CORE -> SINGLE_PARAM_STUDIES_QUERIES_CORE : persist regressionModelDf
        SINGLE_PARAM_STUDIES_QUERIES_CORE -> SINGLE_PARAM_STUDIES_QUERIES_CORE : regressionModelDf.count()

        group Top 5 highest/lowest increment
            SINGLE_PARAM_STUDIES_QUERIES_CORE -> SPARK_QUERIES_CORE : getTopNClimateParamIncrementInAYearLapse(stationIds, regressionModelDf, params)
            SPARK_QUERIES_CORE --> SINGLE_PARAM_STUDIES_QUERIES_CORE : DataFrame
            SINGLE_PARAM_STUDIES_QUERIES_CORE -> SPARK_SESSION_CORE : saveDataframeAsParquet(resultsDF, path)
            SPARK_SESSION_CORE -> STORAGE : write parquet
            STORAGE --> SPARK_SESSION_CORE : saved
            SPARK_SESSION_CORE --> SINGLE_PARAM_STUDIES_QUERIES_CORE : saved
        end

        SINGLE_PARAM_STUDIES_QUERIES_CORE -> SINGLE_PARAM_STUDIES_QUERIES_CORE : unpersist regressionModelDf
    end

    group Avg temperature 2024 (continental/canary)
        SINGLE_PARAM_STUDIES_QUERIES_CORE -> SPARK_QUERIES_CORE : getAllStationsByStatesAvgClimateParamInALapse(params)
        SPARK_QUERIES_CORE --> SINGLE_PARAM_STUDIES_QUERIES_CORE : DataFrame
        SINGLE_PARAM_STUDIES_QUERIES_CORE -> SPARK_SESSION_CORE : saveDataframeAsParquet(resultsDF, path)
        SPARK_SESSION_CORE -> STORAGE : write parquet
        STORAGE --> SPARK_SESSION_CORE : saved
        SPARK_SESSION_CORE --> SINGLE_PARAM_STUDIES_QUERIES_CORE : saved
    end

end

SINGLE_PARAM_STUDIES_QUERIES_CORE --> SPARK_QUERIES_CORE : done
deactivate SINGLE_PARAM_STUDIES_QUERIES_CORE

@enduml
