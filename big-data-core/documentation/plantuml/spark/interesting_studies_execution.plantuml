@startuml
participant "SparkQueriesCore" as SPARK_QUERIES_CORE
participant "InterestingStudiesQueriesCore" as INTERESTING_STUDIES_QUERIES_CORE
participant "SparkSessionCore" as SPARK_SESSION_CORE
participant "Storage" as STORAGE

SPARK_QUERIES_CORE -> INTERESTING_STUDIES_QUERIES_CORE : execute()
activate INTERESTING_STUDIES_QUERIES_CORE

group Precipitation & Pressure evolution
    loop stationRecords
        INTERESTING_STUDIES_QUERIES_CORE -> SPARK_QUERIES_CORE : getStationInfoById(stationId)
        SPARK_QUERIES_CORE --> INTERESTING_STUDIES_QUERIES_CORE : StationInfo DF
        INTERESTING_STUDIES_QUERIES_CORE -> SPARK_SESSION_CORE : saveDataframeAsJSON(stationDf, path)
        SPARK_SESSION_CORE -> STORAGE : write json
        STORAGE --> SPARK_SESSION_CORE : saved
        SPARK_SESSION_CORE --> INTERESTING_STUDIES_QUERIES_CORE : saved

        INTERESTING_STUDIES_QUERIES_CORE -> SPARK_QUERIES_CORE : getClimateParamInALapseById(stationId, params)
        SPARK_QUERIES_CORE --> INTERESTING_STUDIES_QUERIES_CORE : DataFrame
        INTERESTING_STUDIES_QUERIES_CORE -> SPARK_SESSION_CORE : saveDataframeAsParquet(resultsDF, path)
        SPARK_SESSION_CORE -> STORAGE : write parquet
        STORAGE --> SPARK_SESSION_CORE : saved
        SPARK_SESSION_CORE --> INTERESTING_STUDIES_QUERIES_CORE : saved

        INTERESTING_STUDIES_QUERIES_CORE -> SPARK_QUERIES_CORE : getClimateYearlyGroupById(stationId, params)
        SPARK_QUERIES_CORE --> INTERESTING_STUDIES_QUERIES_CORE : DataFrame
        INTERESTING_STUDIES_QUERIES_CORE -> SPARK_SESSION_CORE : saveDataframeAsParquet(resultsDF, path)
        SPARK_SESSION_CORE -> STORAGE : write parquet
        STORAGE --> SPARK_SESSION_CORE : saved
        SPARK_SESSION_CORE --> INTERESTING_STUDIES_QUERIES_CORE : saved
    end
end

group Top 10 states by climate conditions
    loop each top10 config
        INTERESTING_STUDIES_QUERIES_CORE -> SPARK_QUERIES_CORE : getTopNClimateConditionsInALapse(climateParams, startDate, endDate, groupByState=true)
        SPARK_QUERIES_CORE --> INTERESTING_STUDIES_QUERIES_CORE : DataFrame
        INTERESTING_STUDIES_QUERIES_CORE -> SPARK_SESSION_CORE : saveDataframeAsParquet(resultsDF, path)
        SPARK_SESSION_CORE -> STORAGE : write parquet
        STORAGE --> SPARK_SESSION_CORE : saved
        SPARK_SESSION_CORE --> INTERESTING_STUDIES_QUERIES_CORE : saved
    end
end

INTERESTING_STUDIES_QUERIES_CORE --> SPARK_QUERIES_CORE : done
deactivate INTERESTING_STUDIES_QUERIES_CORE

@enduml
